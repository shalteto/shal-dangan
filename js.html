<script>
    /**
     * Global App State
     */
    const APP_DATA = {
        guns: [],
        bulletTypes: [],
        places: [],
        uses: [],
        inventory: {},
        modalMode: 'settings' // 'settings' or 'history'
    };

    // Loading Indicator
    const toggleLoading = (show) => {
        const el = document.getElementById('loadingOverlay');
        if (show) {
            el.classList.add('d-flex');
            el.style.display = '';
        } else {
            el.classList.remove('d-flex');
            el.style.display = 'none';
        }
    };

    // Initialize
    window.onload = function () {
        toggleLoading(true);
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(onFailure)
            .getMetaData();

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
        const startDateStr = oneMonthAgo.toISOString().split('T')[0];

        document.querySelectorAll('input[type="date"]').forEach(el => {
            if (el.id === 'historyStartDate' || el.id === 'historyEndDate') return;
            el.value = todayStr;
        });
        document.getElementById('historyStartDate').value = startDateStr;
        document.getElementById('historyEndDate').value = todayStr;

        setupEventListeners();
    };

    function setupEventListeners() {
        // Form submit events
        document.getElementById('consumptionForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('purchaseForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('transferForm').addEventListener('submit', handleTransferSubmit);

        // Settings save button
        document.getElementById('saveEditBtn').addEventListener('click', () => {
            if (APP_DATA.modalMode === 'history') {
                History.saveEdit();
            } else {
                Settings.save();
            }
        });
    }

    function onDataLoaded(data) {
        try {
            APP_DATA.guns = data.guns;
            APP_DATA.bulletTypes = data.bulletTypes;
            APP_DATA.places = data.places;
            APP_DATA.uses = data.uses;
            APP_DATA.inventory = data.inventory || {};

            renderAllOptions();

            Settings.renderTable('gun');
            Settings.renderTable('bullet_type');
            Settings.renderTable('place');
            Settings.renderTable('use');

            toggleLoading(false);
        } catch (e) {
            console.error(e);
            alert('UI Init Error: ' + e.message);
            toggleLoading(false);
        }
    }

    function onFailure(error) {
        toggleLoading(false);
        alert('Error: ' + error.message);
    }

    // Partial Refresh (Re-fetch data without reload)
    function refreshData() {
        toggleLoading(true);
        google.script.run
            .withSuccessHandler((data) => {
                onDataLoaded(data);
                // Clear form inputs manually if needed, or keep them?
                // For better UX, maybe keep Use/Gun selected but clear Quantities.
                resetQuantities();
                toggleLoading(false);
            })
            .withFailureHandler(onFailure)
            .getMetaData();
    }

    function resetQuantities() {
        document.querySelectorAll('input[name^="qty_"]').forEach(el => el.value = '0');
        document.getElementById('transferQuantity').value = '';
        document.querySelector('textarea[name="results"]').value = '';

        // Refresh bullet sections to reflect new inventory
        updateConsumptionBullets();
        updateTransferSource();
    }


    /**
     * Render Option Buttons (Chips)
     */
    function renderAllOptions() {
        const useList = APP_DATA.uses.map(u => u.use);
        const allGuns = APP_DATA.guns.map(g => g.gun);
        const purchaseGuns = APP_DATA.guns.filter(g => g.type !== '空気銃').map(g => g.gun);
        const gunShops = APP_DATA.places.filter(p => p.type === '銃砲店').map(p => p.place);
        const ranges = APP_DATA.places.filter(p => p.type === '射撃場').map(p => p.place);

        // Consumption
        renderOptionButtons('consumptionUseOptions', useList, 'consumptionUse', (val) => {
            handleConsumptionUseChange(val);
        });
        renderOptionButtons('consumptionPlaceOptions', ranges, 'consumptionPlaceSelect'); // Note: Hidden when Use != Shooting
        renderOptionButtons('consumptionGunOptions', allGuns, 'consumptionGun', () => updateConsumptionBullets());

        // Purchase
        renderOptionButtons('purchasePlaceOptions', gunShops, 'purchasePlace');
        renderOptionButtons('purchaseUseOptions', useList, 'purchaseUse');
        renderOptionButtons('purchaseGunOptions', purchaseGuns, 'purchaseGun', () => updatePurchaseBullets());

        // Transfer
        renderOptionButtons('transferFromUseOptions', useList, 'transferFromUse', () => updateTransferSource());
        renderOptionButtons('transferGunOptions', allGuns, 'transferGun', () => updateTransferSource());
        // Bullet for transfer is dynamic, handled separately or we make it chips too?
        // Let's keep bullet as chips but it needs dynamic render.
        renderOptionButtons('transferToUseOptions', useList, 'transferToUse', () => validateTransferDest());
    }

    function renderOptionButtons(containerId, items, hiddenInputId, onClickCallback) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        // Keep current selection if valid
        const currentVal = document.getElementById(hiddenInputId).value;

        items.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            if (item === currentVal) btn.classList.add('selected');
            btn.textContent = item;
            btn.onclick = () => {
                // Deselect siblings
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
                // Select self
                btn.classList.add('selected');
                // Update hidden input
                document.getElementById(hiddenInputId).value = item;
                // Trigger callback
                if (onClickCallback) onClickCallback(item);
            };
            container.appendChild(btn);
        });
    }

    /**
     * Logic Specifics
     */

    function handleConsumptionUseChange(use) {
        const isShooting = (use === '射撃');
        document.getElementById('consumptionPlaceContainer').style.display = 'block'; // Always show container

        // Toggle Options vs Input
        document.getElementById('consumptionPlaceOptions').style.display = isShooting ? 'flex' : 'none';
        document.getElementById('consumptionPlaceInputContainer').style.display = isShooting ? 'none' : 'block';

        // Required logic (Manual check needed on submit since hidden input is always there)
        // We handle validation in submit handler

        // Refresh Bullets
        updateConsumptionBullets();
    }

    function updateConsumptionBullets() {
        const gunName = document.getElementById('consumptionGun').value;
        const use = document.getElementById('consumptionUse').value;
        const container = document.getElementById('consumptionBulletSection');
        container.innerHTML = '';

        updateConsumptionCategories(gunName);

        if (!gunName || !use) return;

        const gun = APP_DATA.guns.find(g => g.gun === gunName);
        if (!gun) return;

        const isAirGun = (gun.type === '空気銃');
        const bullets = APP_DATA.bulletTypes.filter(b => String(b.size) === String(gun.size));

        if (bullets.length === 0) {
            container.innerHTML = '<div class="alert alert-light text-center">適合する弾種がありません</div>';
            return;
        }

        if (isAirGun) {
            // 空気銃: 在庫に関係なく全弾種を表示、数量制限なし
            bullets.forEach(b => {
                const div = document.createElement('div');
                div.className = 'bullet-row';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="bullet-label">${b.bullet_type}</div>
                            <div class="bullet-info text-muted small">在庫管理対象外</div>
                        </div>
                        <div class="d-flex align-items-center bg-light rounded p-1">
                            <button type="button" class="btn btn-white shadow-sm qty-btn text-danger" onclick="adjustAirGunQty(this, -10)">-10</button>
                            <button type="button" class="btn btn-white shadow-sm qty-btn text-danger" onclick="adjustAirGunQty(this, -1)">-1</button>
                            <input type="number" name="qty_${b.bullet_type}" class="qty-input" value="0" readonly>
                            <button type="button" class="btn btn-white shadow-sm qty-btn text-success" onclick="adjustAirGunQty(this, 1)">+1</button>
                            <button type="button" class="btn btn-white shadow-sm qty-btn text-success" onclick="adjustAirGunQty(this, 10)">+10</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        } else {
            // 装薬銃: 在庫がある弾種のみ表示、在庫数が上限
            let hasInventory = false;

            bullets.forEach(b => {
                const key = `${use}|${b.bullet_type}`;
                const qty = APP_DATA.inventory[key] || 0;

                if (qty <= 0) return;
                hasInventory = true;

                const div = document.createElement('div');
                div.className = 'bullet-row';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="bullet-label">${b.bullet_type}</div>
                            <div class="bullet-info text-primary">残: <strong>${qty}</strong> 発</div>
                        </div>
                        <div class="d-flex align-items-center bg-light rounded p-1">
                            <button type="button" class="btn btn-white shadow-sm qty-btn text-danger" onclick="adjustQty(this, -1, ${qty})">-</button>
                            <input type="number" name="qty_${b.bullet_type}" class="qty-input" value="0" readonly>
                            <button type="button" class="btn btn-white shadow-sm qty-btn text-success" onclick="adjustQty(this, 1, ${qty})">+</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            if (!hasInventory) {
                container.innerHTML = '<div class="alert alert-secondary text-center">消費可能な弾（在庫）がありません</div>';
            }
        }
    }

    function updateConsumptionCategories(gunName) {
        const container = document.getElementById('consumptionCategoryContainer');
        const options = document.getElementById('consumptionCategoryOptions');
        const input = document.getElementById('consumptionCategory');

        options.innerHTML = '';
        input.value = '';

        if (!gunName) {
            container.style.display = 'none';
            return;
        }

        const gun = APP_DATA.guns.find(g => g.gun === gunName);
        if (!gun) {
            container.style.display = 'none';
            return;
        }

        const categories = [];
        APP_DATA.bulletTypes.forEach(b => {
            if (String(b.size) !== String(gun.size)) return;
            if (!b.category) return;
            if (!categories.includes(b.category)) categories.push(b.category);
        });

        container.style.display = 'block';

        if (categories.length === 0) {
            options.innerHTML = '<div class="text-muted small">カテゴリが未登録です</div>';
            return;
        }

        renderOptionButtons('consumptionCategoryOptions', categories, 'consumptionCategory');
    }

    function adjustAirGunQty(btn, delta) {
        const input = btn.parentNode.querySelector('input');
        let val = parseInt(input.value) || 0;
        let newVal = val + delta;
        if (newVal < 0) newVal = 0;
        input.value = newVal;
    }

    function updatePurchaseBullets() {
        const gunName = document.getElementById('purchaseGun').value;
        const container = document.getElementById('purchaseBulletSection');
        container.innerHTML = '';

        if (!gunName) return;

        const gun = APP_DATA.guns.find(g => g.gun === gunName);
        const bullets = APP_DATA.bulletTypes.filter(b => String(b.size) === String(gun.size));

        if (bullets.length === 0) {
            container.innerHTML = '<div class="alert alert-light">適合する弾種がありません</div>';
            return;
        }

        bullets.forEach(b => {
            const div = document.createElement('div');
            div.className = 'bullet-row';
            div.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="bullet-label">${b.bullet_type}</div>
        <input type="number" name="qty_${b.bullet_type}" class="qty-input bg-light rounded" value="0" readonly style="width:80px">
      </div>
      <div class="d-flex justify-content-between gap-1">
        <div class="d-flex">
            <button type="button" class="btn btn-outline-secondary flex-grow-1 py-2" onclick="adjustPurchase(this, -10)">-10</button>
            <button type="button" class="btn btn-outline-secondary flex-grow-1 py-2 ms-1" onclick="adjustPurchase(this, -1)">-1</button>
        </div>
        <div class="d-flex">
            <button type="button" class="btn btn-outline-secondary flex-grow-1 py-2 me-1" onclick="adjustPurchase(this, 1)">+1</button>
            <button type="button" class="btn btn-outline-secondary flex-grow-1 py-2" onclick="adjustPurchase(this, 10)">+10</button>
        </div>
      </div>
    `;
            container.appendChild(div);
        });
    }

    function adjustQty(btn, delta, max) {
        const input = btn.parentNode.querySelector('input');
        let val = parseInt(input.value) || 0;
        let newVal = val + delta;
        if (newVal < 0) newVal = 0;
        if (newVal > max) newVal = max;
        input.value = newVal;
    }

    function adjustPurchase(btn, delta) {
        // Traverse up to find input. Structure changed slightly in updatePurchaseBullets
        // row -> d-flex -> button
        const row = btn.closest('.bullet-row');
        const input = row.querySelector('input');
        let val = parseInt(input.value) || 0;
        let newVal = val + delta;
        if (newVal < 0) newVal = 0;
        input.value = newVal;
    }


    // Transfer Logic
    function updateTransferSource() {
        const use = document.getElementById('transferFromUse').value;
        const gunName = document.getElementById('transferGun').value;
        const container = document.getElementById('transferBulletOptions');
        container.innerHTML = ''; // Clear chips
        document.getElementById('transferBulletType').value = '';

        document.getElementById('transferCurrentInventory').textContent = '0';
        document.getElementById('transferQuantity').max = 0;
        document.getElementById('transferQuantity').value = '';

        if (!use || !gunName) return;

        const gun = APP_DATA.guns.find(g => g.gun === gunName);
        const bullets = APP_DATA.bulletTypes.filter(b => String(b.size) === String(gun.size));

        const validBullets = [];
        bullets.forEach(b => {
            const key = `${use}|${b.bullet_type}`;
            const qty = APP_DATA.inventory[key] || 0;
            if (qty > 0) {
                validBullets.push({ name: b.bullet_type, qty: qty });
            }
        });

        // Determine if we use renderOptionButtons. 
        // renderOptionButtons takes string array. We need to handle Qty display.
        // Let's implement custom loop here.
        validBullets.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerHTML = `${item.name} <span class="badge bg-white text-dark ms-1">${item.qty}</span>`;
            btn.onclick = () => {
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
                btn.classList.add('selected');
                document.getElementById('transferBulletType').value = item.name;

                // Update max
                document.getElementById('transferCurrentInventory').textContent = item.qty;
                document.getElementById('transferQuantity').max = item.qty;
            };
            container.appendChild(btn);
        });

        if (validBullets.length === 0) {
            container.innerHTML = '<small class="text-muted">移動可能な在庫がありません</small>';
        }
    }

    function validateTransferDest() {
        const from = document.getElementById('transferFromUse').value;
        const to = document.getElementById('transferToUse').value;
        if (from && to && from === to) {
            alert('変更元と変更先には異なる用途を指定してください');
            // Deselect logic would be complex with buttons (find element and remove class)
            // For now just alert.
            document.getElementById('transferToUse').value = "";
            // Re-render to clear selection visual
            renderOptionButtons('transferToUseOptions', APP_DATA.uses.map(u => u.use), 'transferToUse', () => validateTransferDest());
        }
    }

    // Submits
    function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const mode = form.mode.value;

        // Validation for Buttons (Hidden inputs must have value)
        // Required attribute on hidden input doesn't always trigger browser validation UI correctly.
        if (!form.use.value) { alert('用途を選択してください'); return; }
        if (!form.gun.value) { alert('銃を選択してください'); return; }

        const commonData = {
            mode: mode,
            date: form.date.value,
            use: form.use.value,
            gun: form.gun.value
        };

        if (mode === 'consumption') {
            const isShooting = (commonData.use === '射撃');
            if (isShooting) {
                if (!form.placeSelect.value) { alert('射撃場を選択してください'); return; }
                commonData.place = form.placeSelect.value;
            } else {
                if (!form.placeInput.value) { alert('場所を入力してください'); return; }
                commonData.place = form.placeInput.value;
            }
            commonData.results = form.results.value;
        } else {
            if (!form.place.value) { alert('購入店を選択してください'); return; }
            commonData.place = form.place.value;
        }

        const inputs = form.querySelectorAll('input[name^="qty_"]');
        const requests = [];
        inputs.forEach(input => {
            let qty = parseInt(input.value);
            if (qty > 0) {
                if (mode === 'consumption') qty = -qty;
                const req = Object.assign({}, commonData);
                req.bulletType = input.name.replace('qty_', '');
                req.quantity = qty;
                requests.push(req);
            }
        });

        // 消費モードで数量入力がない場合でも登録可能（弾消費なしの狩猟・有害記録）
        if (requests.length === 0) {
            if (mode === 'consumption') {
                // 弾消費なしで登録（日付、用途、場所、銃のみ）
                if (!form.category.value) {
                    alert('弾消費なしの場合は弾種カテゴリを選択してください');
                    return;
                }
                const req = Object.assign({}, commonData);
                req.bulletType = '';
                req.quantity = '';
                req.category = form.category.value;
                requests.push(req);
            } else {
                // 購入の場合は数量必須
                alert('数量が入力されていません');
                return;
            }
        }

        submitBatch(requests);
    }

    function handleTransferSubmit(e) {
        e.preventDefault();
        const form = e.target;

        if (!form.fromUse.value) { alert('変更元用途を選択してください'); return; }
        if (!form.gun.value) { alert('銃を選択してください'); return; }
        if (!form.bulletType.value) { alert('弾種を選択してください'); return; }
        if (!form.toUse.value) { alert('変更先用途を選択してください'); return; }

        const data = {
            mode: 'transfer',
            date: form.date.value,
            fromUse: form.fromUse.value,
            toUse: form.toUse.value,
            gun: form.gun.value,
            bulletType: form.bulletType.value,
            quantity: parseInt(form.quantity.value)
        };

        submitBatch([data]);
    }

    function submitBatch(requests) {
        toggleLoading(true);
        let completed = 0;
        let errors = 0;

        const onFinish = () => {
            completed++;
            if (completed === requests.length) {
                if (errors === 0) {
                    // Success! Refresh data instead of reload
                    alert('登録しました');
                    refreshData();
                } else {
                    toggleLoading(false);
                }
            }
        };

        requests.forEach(req => {
            google.script.run
                .withSuccessHandler(onFinish)
                .withFailureHandler((e) => {
                    alert('Error: ' + e.message);
                    errors++;
                    onFinish();
                })
                .registerData(req);
        });
    }

    // Master Data Settings (Keep mostly same but ensure table selector safety)
    const Settings = {
        currentSheet: null,

        renderTable: (sheetName) => {
            const selector = `#table-${sheetName} tbody`;
            const tbody = document.querySelector(selector);
            if (!tbody) {
                return;
            }
            tbody.innerHTML = '';

            let dataList;
            if (sheetName === 'gun') dataList = APP_DATA.guns;
            else if (sheetName === 'bullet_type') dataList = APP_DATA.bulletTypes;
            else if (sheetName === 'place') dataList = APP_DATA.places;
            else if (sheetName === 'use') dataList = APP_DATA.uses;

            if (!dataList) return;

            dataList.forEach((item, index) => {
                const tr = document.createElement('tr');
                let cols = '';
                if (sheetName === 'gun') cols = `<td>${item.gun}</td><td>${item.type}</td><td>${item.size}</td>`;
                else if (sheetName === 'bullet_type') cols = `<td>${item.bullet_type}</td><td>${item.size}</td><td>${item.type}</td><td>${item.category || ''}</td>`;
                else if (sheetName === 'place') cols = `<td>${item.place}</td><td>${item.type}</td>`;
                else if (sheetName === 'use') cols = `<td>${item.use}</td>`;

                tr.innerHTML = `
        ${cols}
        <td>
          <button class="btn btn-sm btn-danger" onclick="Settings.deleteItem('${sheetName}', ${index})">削除</button>
        </td>
      `;
                tbody.appendChild(tr);
            });
        },

        showAddModal: (sheetName) => {
            APP_DATA.modalMode = 'settings';
            Settings.currentSheet = sheetName;
            const form = document.getElementById('editForm');
            form.innerHTML = '';

            if (sheetName === 'bullet_type') {
                // 弾種類: size と type から bullet_type を自動生成、category はテキスト入力
                form.innerHTML = `
                    <div class="mb-2">
                        <label class="form-label">Size</label>
                        <input type="text" class="form-control" name="size" id="bulletSizeInput" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-control" name="type" id="bulletTypeInput" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" name="category" id="bulletCategoryInput" placeholder="例: スラグ、散弾、空気銃弾">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Bullet (自動生成)</label>
                        <input type="text" class="form-control bg-light" name="bullet_type" id="bulletNamePreview" readonly>
                    </div>
                `;
                // イベントリスナーを追加
                setTimeout(() => {
                    const updatePreview = () => {
                        const size = document.getElementById('bulletSizeInput').value;
                        const type = document.getElementById('bulletTypeInput').value;
                        document.getElementById('bulletNamePreview').value = size && type ? `${size}/${type}` : '';
                    };
                    document.getElementById('bulletSizeInput').addEventListener('input', updatePreview);
                    document.getElementById('bulletTypeInput').addEventListener('input', updatePreview);
                }, 0);
            } else {
                let fields = [];
                if (sheetName === 'gun') fields = ['gun', 'type', 'size'];
                else if (sheetName === 'place') fields = ['place', 'type'];
                else if (sheetName === 'use') fields = ['use'];

                fields.forEach(f => {
                    form.innerHTML += `
                        <div class="mb-2">
                            <label class="form-label text-capitalize">${f}</label>
                            <input type="text" class="form-control" name="${f}" required>
                        </div>
                    `;
                });
            }

            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        },

        save: () => {
            const form = document.getElementById('editForm');
            if (!form.reportValidity()) return;

            const sheetName = Settings.currentSheet;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            toggleLoading(true);
            google.script.run
                .withSuccessHandler(() => {
                    alert('追加しました');
                    // Close modal
                    const el = document.getElementById('editModal');
                    const modal = bootstrap.Modal.getInstance(el);
                    modal.hide();

                    refreshData(); // Refresh instead of reload
                })
                .withFailureHandler((e) => {
                    toggleLoading(false);
                    alert('Error: ' + e.message);
                })
                .updateMasterData(sheetName, 'add', data);
        },

        deleteItem: (sheetName, rowIndex) => {
            if (!confirm('本当に削除しますか？')) return;

            toggleLoading(true);
            google.script.run
                .withSuccessHandler(() => {
                    alert('削除しました');
                    refreshData(); // Refresh instead of reload
                })
                .withFailureHandler((e) => {
                    toggleLoading(false);
                    alert('Error: ' + e.message);
                })
                .updateMasterData(sheetName, 'delete', { rowIndex: rowIndex });
        }
    };

    // History Management for main table
    const History = {
        data: [],

        load: () => {
            console.log('[History] load() called');

            // 日付フィルターの値を取得
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            const filter = {
                startDate: startDate || '',
                endDate: endDate || ''
            };
            console.log('[History] Filter:', filter);

            toggleLoading(true);
            google.script.run
                .withSuccessHandler((data) => {
                    console.log('[History] getMainData success:', data);
                    History.data = data || [];
                    History.render();
                    toggleLoading(false);
                })
                .withFailureHandler((e) => {
                    console.error('[History] getMainData error:', e);
                    toggleLoading(false);
                    alert('Error: ' + e.message);
                })
                .getMainData(filter);
        },

        clearFilter: () => {
            document.getElementById('historyStartDate').value = '';
            document.getElementById('historyEndDate').value = '';
            History.load();
        },

        render: () => {
            console.log('[History] render() called, data length:', History.data.length);
            const tbody = document.querySelector('#table-main tbody');
            const emptyMsg = document.getElementById('historyEmpty');
            tbody.innerHTML = '';

            if (History.data.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';

            // 日付の昇順で表示
            const sorted = [...History.data].sort((a, b) => (a.date || '').localeCompare(b.date || ''));

            sorted.forEach(item => {
                const tr = document.createElement('tr');
                const qtyDisplay = item.quantity !== '' ? item.quantity : '-';
                const bulletDisplay = item.bullet_type || '-';
                const resultsDisplay = item['note'] || '';

                tr.innerHTML = `
                    <td class="text-nowrap">${item.date || ''}</td>
                    <td>${item.use || ''}</td>
                    <td>${bulletDisplay}</td>
                    <td class="${item.quantity < 0 ? 'text-danger' : (item.quantity > 0 ? 'text-success' : '')}">${qtyDisplay}</td>
                    <td>${item.place || ''}</td>
                    <td>${item.gun || ''}</td>
                    <td class="small">${resultsDisplay}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="History.edit(${item.rowIndex})">編集</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="History.delete(${item.rowIndex})">削除</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        },

        delete: (rowIndex) => {
            if (!confirm('このレコードを削除しますか？\nこの操作は元に戻せません。')) return;

            toggleLoading(true);
            google.script.run
                .withSuccessHandler(() => {
                    alert('削除しました');
                    History.load(); // リスト更新
                    refreshData(); // 在庫も更新（inventory再計算）
                })
                .withFailureHandler((e) => {
                    toggleLoading(false);
                    alert('Error: ' + e.message);
                })
                .deleteMainRecord(rowIndex);
        },

        edit: (rowIndex) => {
            APP_DATA.modalMode = 'history';
            const item = History.data.find(d => d.rowIndex === rowIndex);
            if (!item) return;

            const form = document.getElementById('editForm');
            form.innerHTML = '';

            // Generate Options Helpers
            const createSelect = (name, list, selected, keyName) => {
                let html = `<select class="form-select" name="${name}">`;
                html += `<option value="">(選択なし)</option>`;
                list.forEach(opt => {
                    const val = keyName ? opt[keyName] : opt;
                    const isSelected = val === selected ? 'selected' : '';
                    html += `<option value="${val}" ${isSelected}>${val}</option>`;
                });
                html += `</select>`;
                return html;
            };

            // uses
            const useSelect = createSelect('use', APP_DATA.uses, item.use, 'use');
            // guns
            const gunSelect = createSelect('gun', APP_DATA.guns, item.gun, 'gun');
            // bullet_types
            const bulletSelect = createSelect('bullet_type', APP_DATA.bulletTypes, item.bullet_type, 'bullet_type');

            // places (datalist for flexibility + existing filtering logic is complex, just show all or input)
            // Existing app uses filtered chips. Here we use datalist for simplicity & compactness.
            const placesList = APP_DATA.places.map(p => p.place);
            let placeDatalist = '<datalist id="editPlaceOptions">';
            placesList.forEach(p => { placeDatalist += `<option value="${p}">`; });
            placeDatalist += '</datalist>';

            form.innerHTML = `
                <input type="hidden" name="rowIndex" value="${item.rowIndex}">
                
                <div class="mb-2">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" name="date" value="${item.date}" required>
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Use</label>
                    ${useSelect}
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Gun</label>
                    ${gunSelect}
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Bullet Type</label>
                    ${bulletSelect}
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control" name="quantity" value="${item.quantity !== '' ? item.quantity : 0}" required>
                    <div class="form-text">消費はマイナス、購入はプラスで入力</div>
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Place</label>
                    <input type="text" class="form-control" name="place" value="${item.place}" list="editPlaceOptions">
                    ${placeDatalist}
                </div>
                
                <div class="mb-2">
                    <label class="form-label">Note</label>
                    <textarea class="form-control" name="note" rows="2">${item.note || ''}</textarea>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        },

        saveEdit: () => {
            const form = document.getElementById('editForm');
            if (!form.reportValidity()) return;

            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            // Quantity conversion
            if (data.quantity) data.quantity = parseInt(data.quantity);
            if (data.rowIndex) data.rowIndex = parseInt(data.rowIndex);

            toggleLoading(true);
            google.script.run
                .withSuccessHandler(() => {
                    alert('更新しました');
                    // Close modal
                    const el = document.getElementById('editModal');
                    const modal = bootstrap.Modal.getInstance(el);
                    modal.hide();

                    History.load();
                    refreshData();
                })
                .withFailureHandler((e) => {
                    toggleLoading(false);
                    alert('Error: ' + e.message);
                })
                .updateMainRecord(data);
        }
    };
</script>